FROM docker.io/fedora:42

ARG USER=queil
ARG HOME=/home/$USER

RUN microdnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo && \
    microdnf update -y && \
    microdnf install -y --nodocs --setopt install_weak_deps=0 \
    man mmv nu systemd tar unzip bash-completion git git-delta micro jq dnsutils \
    iproute htop which procps-ng tree && \
    docker-ce-cli docker-compose-plugin && \
    ln -s /usr/bin/python3 /usr/bin/python && \
    adduser $USER && chown $USER -R $HOME

WORKDIR $HOME
USER $USER

ENV PATH="$HOME/.local/bin:${PATH}"

RUN curl -sSL https://starship.rs/install.sh -o ./install.sh && \
    chmod +x ./install.sh && mkdir -p ./.local/bin && ./install.sh --yes --bin-dir=./.local/bin && rm ./install.sh

ARG EGET_VER=1.3.4
ARG ZELLIJ_VER=0.43.1
ARG BROOT_VER=1.47.0
ARG JJ_VER=0.33.0
ARG ROOZ_VER=0.130.0

RUN curl -sSL "https://github.com/zyedidia/eget/releases/download/v${EGET_VER}/eget-${EGET_VER}-linux_amd64.tar.gz" -o /tmp/eget.tar.gz && \
    tar -zxvf /tmp/eget.tar.gz -C /tmp && mv "/tmp/eget-${EGET_VER}-linux_amd64/eget" ./.local/bin/ && chmod +x ./.local/bin/eget && rm /tmp/eget.tar.gz && \
    echo -e '[global]\ntarget = "~/.local/bin"' > ~/.eget.toml && \
    eget zellij-org/zellij --asset=zellij-no-web --tag "v${ZELLIJ_VER}" && \
    eget Canop/broot --file=x86_64-unknown-linux-gnu/broot --tag "v${BROOT_VER}" && \
    eget jj-vcs/jj --tag "v${JJ_VER}" && \
    eget queil/rooz --tag "v${ROOZ_VER}"

ARG INIT_REPO=https://github.com/queil/image
ARG INIT_BRANCH=main

ADD --chown=$USER https://api.github.com/repos/queil/image/git/refs/heads/$INIT_BRANCH $HOME/.git-ref

WORKDIR $HOME/.upd

RUN git clone --no-checkout $INIT_REPO . && \
    git sparse-checkout init --cone && \
    git sparse-checkout set ./init && \
    git checkout $INIT_BRANCH

WORKDIR $HOME

RUN "./.upd/init/home/$USER/update.sh"


# this is needed for tools like: dockerd-rootless.sh or zellij
ENV XDG_RUNTIME_DIR="/tmp"

WORKDIR $HOME
